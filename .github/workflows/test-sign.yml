name: Test Code Signing

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to test (leave empty for latest)"
        required: false
        type: string

jobs:
  test-sign:
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            pattern: vibe_aarch64.app.tar.gz
          - runner: macos-15-intel
            pattern: vibe_x64.app.tar.gz
          - runner: windows-latest
            pattern: "vibe_*_x64-setup.exe"

    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .

      - name: Download release artifact
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          tag="${{ inputs.tag }}"
          if [ -z "$tag" ]; then
            tag=$(gh release list --repo ${{ github.repository }} --limit 1 --json tagName --jq '.[0].tagName')
          fi
          echo "Downloading from release: $tag"
          gh release download "$tag" --repo ${{ github.repository }} --pattern "${{ matrix.pattern }}"

      - name: Verify macOS code signature
        if: runner.os == 'macOS'
        run: |
          tar xzf ${{ matrix.pattern }}
          echo "=== codesign verify ==="
          codesign --verify --deep --strict --verbose=2 vibe.app
          echo "=== spctl assess (notarization) ==="
          spctl --assess --type execute --verbose=2 vibe.app
          echo "=== signing authority ==="
          codesign -dv --verbose=4 vibe.app 2>&1 | grep -E "Authority|TeamIdentifier|Signature"

      - name: Verify Windows code signature
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $installer = (Get-Item vibe_*_x64-setup.exe).FullName
          echo "=== Authenticode signature ==="
          $sig = Get-AuthenticodeSignature $installer
          echo "Status: $($sig.Status)"
          echo "Signer: $($sig.SignerCertificate.Subject)"
          echo "Issuer: $($sig.SignerCertificate.Issuer)"
          echo "Thumbprint: $($sig.SignerCertificate.Thumbprint)"
          echo "Valid from: $($sig.SignerCertificate.NotBefore) to $($sig.SignerCertificate.NotAfter)"
          if ($sig.Status -ne "Valid") {
            echo "::error::Code signature is not valid: $($sig.Status)"
            exit 1
          }
          echo "Code signature is valid"

          echo "=== Certificate chain validation ==="
          $chain = New-Object Security.Cryptography.X509Certificates.X509Chain
          $chain.ChainPolicy.RevocationMode = "Online"
          $chain.ChainPolicy.RevocationFlag = "EntireChain"
          $built = $chain.Build($sig.SignerCertificate)
          foreach ($element in $chain.ChainElements) {
            echo "  $($element.Certificate.Subject)"
          }
          if (-not $built) {
            foreach ($status in $chain.ChainStatus) {
              echo "::error::Chain error: $($status.StatusInformation)"
            }
            exit 1
          }
          echo "Certificate chain is trusted"
